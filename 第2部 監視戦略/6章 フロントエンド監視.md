# フロントエンド監視

- 多くの会社では見て見ぬ振りされがち
- 「フロントエンド」とは、ブラウザあるいはネイティブなモバイルアプリケーションによってパースされて実行されるすべてのこと
- SPAが広く使われるようになって、伝統的なやり方での監視は通用しなくなってきた
- ゴールは「動き続けること」ではなく「素早くロードされること」
- フロントエンドのパフォーマンスは、画像・JS・CSSなどあらゆる静的アセットのサイズに影響される

## 遅いアプリケーションのコスト

- ページロード時間が1秒遅くなると
  - ページビューが11％下がる
  - コンバージョンが7%下がる
  - 顧客満足度が16％下がる
- 最適なロード時間は2秒以下
  - 5.1秒を超えるとビジネスに影響が出始める

## フロントエンド関しの2つのアプローチ

- リアルユーザー監視とシンセティック監視がある
- ホワイトボックス監視とブラックボックス監視とも言える
- リアルユーザー監視
  - Google Analytics
  - 監視のデータとして実際のユーザートラフィックを使う
- シンセティック監視
  - WebpageTest.org
  - テスト環境家で偽のリクエストを生成する

## DOM

- Document Object Model
- Webページを論理的に表現したツリー
- HTMLとDOMは完全に対応している
- DOMがパースされ`<script>`タグに遭遇すると、ブラウザはDOMのパースを停止して、スクリプトをロードする
- スクリプトの大きさがページのパフォーマンスに大きく影響する

### フロントエンドパフォーマンスのメトリクス

#### Navigation Timing API

- ブラウザは、W3Cによって推奨されているNavigation Timing APIという仕様に基づいたAPIを通じて、ページパフォーマンスのメトリクスを公開している

常に有益なメトリクスを抜粋

<dl>
  <dt>navigationStart</dt>
  <dd>ブラウザによってページリクエストが開始されたタイミング</dd>
  <dt>domLoading</dt>
  <dd>DOMがコンパイルされロードが始まったタイミング</dd>
  <dt>domInteractive</dt>
  <dd>ページが使用可能になったと考えられるタイミング（ページのロードが終わっているとは限らない）</dd>
  <dt>domContentLoaded</dt>
  <dd>すべてのスクリプトが実行されたタイミング</dd>
  <dt>domComplete</dt>
  <dd>ページがすべて（HTML, CSS, JavaScript）のロードを終えたタイミング</dd>
</dl>

#### Speed Index

- 視覚的な観点で、いつページがロードされ終わったのかを判断する
- 秒間10フレームのビデオキャプチャを使う

### 素晴らしい！でもどうやったらいいの？

- `domComplete` - `navigationStart` = ページの総ロード時間
- `domInteractive` - `navigationStart` = ページがロードされたとユーザーが体感する時間

## ロギング

- SaaSプロダクトを使って、JavaScriptから例外やログメッセージを収集してホステッドサービスに送る

## シンセティック監視

- webサイトが動いているか確認するために`curl`を実行するのは、シンセティックテスト
- WebpageTestのAPIを自動テスト環境で使うようにするとよい
  - 過去のパフォーマンス改善の効果を失ってしまうことを避けられる
