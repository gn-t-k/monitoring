# サーバー監視

## OSの標準的なメトリクス

- 監視を始めるときはここからはじめるべきではない
- 診断やトラブルシューティングといった正しいコンテキストで使えば便利
- 全システムで自動的に記録するようにしておきつつ、アラートは設定しないことをオススメする

### CPU

- `top`コマンド
  - 使用率を判断するには、↓を足し合わせる
    - ユーザー`us`
    - システム`sy`
    - 優先度付きプロセス`ni`
    - ハードウェア割り込み`hi`
    - ソフトウェア割り込み`si`
  - ↓はサービスの実行ではなく待ち時間なので、使用率には含めない
    - IO待ちプロセス`wa`
    - steal時間`st`

### メモリ

- メモリ使用率は、shared、cached、buffersに分類できる（すべてusedとしてまとめられる）
- `free -m`コマンド
  - `Mem`
    - `buffers`
      - ディスクの中で最近アクセスされた領域のファイルシステムメタデータ（ディレクトリのパーミッションや中身）を保存する
      - バッファーを利用することで、アクセス時間の短縮を期待している
    - `cached`
      - 最近アクセスされたファイルのコンテンツを保存する
  - `buffers/cache`
    - メモリ使用率を測定するのに有益
    - `used` … 使用しているメモリからbuffersとcachedを引いたもの
    - `free` … 空いているメモリにbuffersとcachedを足したもの
  - `Swap`
    - システムにスワップパーティションやファイルがある（最近のクラウドインフラではあまり一般的ではない）場合、この値を追跡する
    - アプリケーションがメモリに敏感な場合、freeメモリが減っている & スワップ使用量が増加したときのアラートは、重要な指標になる
- OOMKiller
  - メモリ仕様が増えてきた時、システムで使用可能なメモリを増やすためにプロセスを停止する役割
  - システムログを`killed process`で`grep`すれば見つかる
  - OOMKillerの発生時にアラートを送る仕組みを作るのをオススメする

### ネットワーク

- `ipconfig`や`ip`が広く使われている（`/proc/net/dev`がもとになっている）
- インターフェイスに対するインとアウトのオクテット数、エラー数、ドロップ数を収集する
- **全然わからん**

### ディスク

- ディスクパフォーマンスを見る方法の多くは、`/proc/diskstats`から情報を取得している
- `iostat -x`
  - `iowait`が高い状態は避けたい
  - `await`は、ディスクが処理を行うようリクエストを発行するのにかかった平均時間
  - `%util`はディスクの使用率
  - `tps`は、transfers per secondの略で、データの転送能力を増強するかどうかを判断したり、一般的なパフォーマンス問題を特定するのに便利

### ロードアベレージ

- CPUに処理してもらうのを待っているプロセスがいくつあるかの指標
- `uptime`コマンドを使う（`/proc/loadavg`からデータを取得してくる）
- 高い数値を示していてもサーバーは問題なく動いているということもある（何も影響がないのなら、問題ではない）
- 「代理指標」として役に立つ
  - ロードアベレージが異常に高い場合、他の問題が存在していることを示すことがある
- 一般的に、ロードアベレージに依存することは時間のムダ

## SSL証明書

## SNMP

## Webサーバー

## データベースサーバー

## ロードバランサー

## メッセージキュー

## キャッシュ

## DNS

## NTP

## それ以外の企業インフラにおける監視

### DHCP

### SMTP

## スケジュールジョブの監視

## ロギング

### 収集

### 保存

### 分析
