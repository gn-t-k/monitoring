# 監視のデザインパターン

## デザインパターン1：組み合わせ可能な監視

- 専門化されたツールを複数使い、それらを疎に結合させて、監視「プラットフォーム」を作る
- 1つのツールややり方に長期間コミットする必要がない
  - あるツールがやり方に合わなくなったら、そのツールだけ別のツールに変えればよい
- アーキテクチャは複雑になるが、得られるコストのほうが大きい

### 監視サービスのコンポーネント

- 監視サービスには5つの要素がある。

#### データ収集

- データ収集には方法として「プッシュ」と「プル」がある
  - プル型は、中央サービスがリモートノードに対して、ノードの情報を送りつけてくるよう要求する
    - 中央サービスがスケジュールについて責任を持つ
    - 中央サービスがすべてのクライアントを把握してスケジュールし、応答をパースしなくてはならないので、スケールしにくい
  - プッシュ型は、クライアントがデータを他の場所に一定間隔あるいはイベントが発生したタイミングでプッシュする
    - スケールしやすい
  - どんなデータを集めるかによって「メトリクス」と「ログ」の2種類のデータがある

##### メトリクス

メトリクスには「カウンター」と「ゲージ」の2つの表現方法がある。

###### カウンター

- 増加していくメトリクス
- 例
  - webサイトに訪れる累計人数
  - ネットワークインターフェイスのトラフィック
- カウンターには上限があり、上限を超えてしまうと、カウンターは最初に戻りまた0から始まる

###### ゲージ

- ある時点の値
- 過去の値についてなんの情報もアタ会えてくれず、本来の値を推測するヒントもくれない
- ゲージの値を時系列に保存することで、あとから過去のデータを取り出したり、グラフにプロットしたりできる

##### ログ

- 基本的には連続した文字列のこと
- いつイベントが発生したのかを示すタイムスタンプが関連付けられている
- 何らかのパースが必要になる
- 構造化ログと非構造化ログがある
  - 非構造化ログ
    - 各フィールドに対して明確な意味のマッピングがない
    - 順序が意味を保つ場合があり、慣れていない人はドキュメントを見ないと読めない場合がある
  - 構造化ログ
    - JSONなどで構造化し、ログエントリをキーと値のペアの集合にできる
    - 機械的に情報を抽出するのもやりやすい
- ログの収集には、別の場所にログを転送するように設定するとよい
  - ログが保存されてあるそれぞれのサーバーにログインするより、一箇所のダッシュボードでまとめて見れたほうがよい

#### データストレージ

- データを収集したら、それをどこかに保存する必要がある
- 通常は時系列データベースに保存される
  - タイムスタンプと値というキー/バリューで構成されるデータを保存する専用のデータベース
- キー/バリューのペアはデータポイントと呼ばれる
- 一定期間後にデータの「間引き」や「有効期限切れ」が発生する
  - データが古くなったら、複数のデータポイントが1つのデータポイントにまとめられることを意味する
  - よくある間引きの方法としては、平均化などがある
  - 例
    - 60秒に1回データを収集して1日はそのままの分解能で保存する
    - 3日後に5分単位でまとめる場合
    - 24時間分のメトリクスは86400データポイントあるのに対し、その後3日間では864データポイントしかないことになる
  - データの間引きはよくないという意見もあるが、収集するデータの大部分は間引いても問題ない
- ログの保存には2つの方法がある
  - シンプルな通常のファイルにデータを保存する
  - Elasticsearchなどの検索エンジンに保存する

#### 可視化

- モノリシックなツールを使った場合、付属のダッシュボードには自分で何かを作る余地はほとんど残っていないため、それに縛られがち
- 組み合わせ可能に作ったツールを使っているならば、自分で何かを作ることはやりやすくなる
- たくさんのデータを持つことはよいことだが、開発者やチームの求めるものに沿った形で表現できないのであれば、ムダなデータになる
- 時系列データのもっとも一般的な可視化の方法は折れ線グラフ
- 円グラフには過程やトレンドといった情報が含まれていない

#### 分析とレポート

- サービスの可用性をSLAとして定義して、レポートする場合がある
- 可用性を計測してSLAを定義することは難しい
  - 1分単位でダウンタイムを計測するには、30秒未満の間隔でデータを計測する必要がある
  - 各コンポーネントの可用性を計測した上で、全体の可用性を計算する必要がある
  - コンポーネント間の依存関係にも注意する必要がある

#### アラート

- 監視は、アラートを出すためだけに存在しているのではない
  - アラートは結果の1つの形でしかない
  - 収集しているメトリクスやグラフは、アラートと1対1対応している必要はない
- 監視は、質問を投げかけるためにある
  - **どういう意味？**

## デザインパターン2：ユーザー視点での監視

- 監視を始めるにあたってまず手を付ける場所は、ユーザーに近いところから（UI）
- アプリケーションが動いているかどうか
  - HTTPレスポンスコード
  ーリクエスト時間
- 何が問題なのかは教えてくれないが、何かが問題で、それがユーザーに影響を与えていることがわかる

## デザインパターン3：作るのではなく買う

- 多くの企業は「SaaSサービスを使う」→「関しの仕組みを社内に構築する」→「独自の監視プラットフォームを構築する」という道をたどる

### 安いから

- ツールを構築する場合、人を雇うお金や開発・運用のコストがかかる（機会損失も）

### あなたは（おそらく）監視ツールを設計する専門家ではないから

- 監視ツールは専門家が作ったもの

### SaaSを使うとプロダクトにフォーカスできるから

- SaaSツールを使うと、簡単かつすぐに関しの仕組みを立ち上げて運用を始められる
- ドキュメントもある

### 実際のところSaaSのほうがよいから

- SaaSだと機能が足りないとかお金がかかるとか、それ本当？
- 技術的あるいは経済的な合理性を考えよう

## デザインパターン4：継続的改善

- いい監視をしている企業、何年もかけてそこにたどり着いている
- 監視は常に改善し続けよう
