# 3章_アラート、オンコール、インシデント管理

アラートがないと、不具合にすぐ気づけない。

## どうしたらアラートをよくできるか

### アラートにメールを使うのをやめよう

- メールでアラートを送ると、受け取る人はうんざりして疲れてしまう
- アラートの使い道は以下の3つに集約される

#### すぐに応答がアクションが必要なアラート

- SMS、PagerDutyなどのオページャーに送信する
- 本来のアラート

#### 注意が必要だがすぐにアクションは必要ないアラート

- チャットルームに送るのが筆者の好み
- メールで送るのもなしではないが、メールボックスを埋め尽くす

#### 履歴や診断のために保存しておくアラート

- ログファイルに送るべき

### 手順書を書こう

- 「手順書」とは、アラートが来たときにすばやく自分の進むべき方向を示す素晴らしい方法
- 以下のような質問に答えるように書かれた手順書
  - これは何のサービスで、何をするものか
  - 誰が責任者か
  - どんな依存性を持っているのか
  - インフラの構成はどのようなものか
  - どんなメトリクスやログを送っっていて、それはどういう意味なのか
  - どんなアラートが設定されていて、その理由は何なのか
- 各アラートには対象サービスの手順書へのリンクを入れる
- アラートに対応する修復手順がコピーアンドペーストできるくらいにシンプルなコマンドなら、それは手順書のあり方がおかしくなっている兆候
  - 自動化できる
  - 手順書は、何らかの問題を解決するのに、人間の判断と診断が必要なときのためのもの

### 固定の閾値を決めることだけが方法ではない

- 閾値を超えた、というアラートに意味がないこともある
  - 例：ディスク使用量が90%を超えたときのアラート
    - ディスク使用量が11%から80%に急上昇した場合を見逃してしまう
    - 「一定期間内に一定量増加」など、変化量やグラフの傾きに着目すると良い
- 移動平均、信頼区間、標準偏差などの統計情報も使うと良い

### アラートを削除し、チューニングしよう

- うるさいアラームによって人は監視システムを信用しなくなり、無視するようになる
- アラートを減らす方法
  1. 誰かがアクションする必要がある状態のみアラートする
  2. アラートの履歴を振り返ってみる
  3. 対応が自動化できるなら、自動化する

### メンテナンス期間を使おう

- なんらかの作業によってアラートが発生するとわかっているなら、アラートは一時停止する
- 止めすぎに注意する（機能を壊してしまったことに気付かないなど起こるかも）

### まずは自動復旧を試そう

- 手順書に沿って対応するだけ、のアラートであれば、自動復旧を試みる

## オンコール

### 誤報を修正する

- アラートをチューニングする方法
  1. 前日に送られたすべてのアラートの一覧を作る
  2. 各アラートはどのように改善できるか、あるいは削除してしまえないかどうか自問自答する
  3. これを毎日やる

### 無用の場当たり的対応を減らす

- オンコールシフト中、場当たり的対応をしていない時間は、システムの回復力や安定性に対して取り組むのをオンコール担当の役割にする
- 次のスプリントで、システムの回復性や安定性について取り上げる計画を立てる

### 上手にオンコールローテーションを組む

- ずっと同じ人にさせない
- 定期的にローテーションさせる
- ローテーション時にオンコールの引き継ぎを行う
- バックアップのオンコールは必要ない
- オンコール担当が対応できないことに対しては、エスカレーションパスを用意しておく
- ソフトウェアエンジニアもオンコールのシフトにいれておくことで、よりよいソフトウェアをつくろうという流れが生まれる

## インシデント管理

- インシデント発生時の対応フローなど決める
- インシデント発生時の役割を決める
  - 会社での通常の上下関係を、インシデント対応時の上下関係に当てはめるのはアンチパターン
  - エンジニアを現場指揮係、マネージャーを調整係にするとよい

## 振り返り

- 何が起きたのか、なぜ起きたのか、どうやって修正したのか、再発防止策について議論する
- 誰かを非難することはしない
